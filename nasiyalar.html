<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nasiyalar – Grand Smart Shop</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }
    nav { margin-bottom: 1rem; }
    nav a { text-decoration: none; color: #007bff; font-size: 0.9rem; }
    h1 { font-size: 1.4rem; text-align: center; margin-bottom: 0.5rem; }
    #totalSum { font-weight: bold; font-size: 1.1rem; text-align: center; margin-bottom: 1rem; }
    .nasiya {
      background: #fff;
      border-radius: 8px;
      padding: 0.8rem;
      margin-bottom: 0.6rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .nasiya-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
    }
    .tarix {
      margin-top: 0.6rem;
      display: none;
      font-size: 0.95rem;
      padding-left: 0.5rem;
      border-left: 2px solid #ddd;
    }
    .input-group { margin-bottom: 0.8rem; }
    .input-group label { display: block; margin-bottom: 0.3rem; }
    .input-group input,
    .input-group textarea,
    .input-group select {
      width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;
    }
    button {
      cursor:pointer; padding:0.5rem 1rem; border:none; border-radius:5px;
      background:#007bff; color:#fff;
    }
    .modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); align-items:center; justify-content:center;
    }
    .modal-content {
      background:#fff; padding:1rem; border-radius:8px;
      width:90%; max-width:400px;
    }
    @media (max-width:600px) {
      body { padding:0.6rem; }
      h1 { font-size:1.2rem; }
    }
  </style>
</head>
<body>

  <nav><a href="index.html">◀ Bosh sahifa</a></nav>
  <h1>Nasiyalar</h1>
  <div id="totalSum">Nasiyalar: yuklanmoqda...</div>

  <div class="input-group" style="text-align:center; margin-bottom:1rem;">
    <button id="addNasiyaBtn">➕ Nasiya qo‘shish</button>
  </div>

  <div id="nasiyaList"></div>

  <!-- Modal -->
  <div id="nasiyaModal" class="modal">
    <div class="modal-content">
      <h2>Nasiya qo‘shish</h2>
      <form id="nasiyaForm">
        <div class="input-group">
          <label for="formIsm">Ismi</label>
          <input type="text" id="formIsm" required />
        </div>
        <div class="input-group">
          <label for="formOldi">Oldi (pul oldi)</label>
          <input type="number" id="formOldi" value="0" />
        </div>
        <div class="input-group">
          <label for="formBerdi">Berdi (pul berdi)</label>
          <input type="number" id="formBerdi" value="0" />
        </div>
        <div class="input-group">
          <label for="formFoiz">Foiz</label>
          <select id="formFoiz">
            <option value="0">0%</option>
            <option value="0.5">0.5%</option>
            <option value="1">1%</option>
            <option value="1.5">1.5%</option>
            <option value="2">2%</option>
          </select>
        </div>
        <div class="input-group">
          <label for="formIzoh">Izoh</label>
          <textarea id="formIzoh" rows="2"></textarea>
        </div>
        <div style="text-align:right;">
          <button type="button" id="closeModalBtn" style="background:#ccc; color:#000;">Bekor qilish</button>
          <button type="submit">Saqlash</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyMlhXOrF_JiY1SDC-v5TIlEsV5R3AeUkcxUrc4wlUsFrC7GVzDdVOa5vxDEQqaXinafA/exec";
    let nasiyalarData = [];

    function formatSum(sum) {
      return sum.toLocaleString("uz-UZ") + " so'm";
    }

    async function loadNasiyalar() {
      const res = await fetch(API_URL);
      const raw = await res.json();
      const map = {};
      raw.forEach(r => {
        if (!map[r.ism]) map[r.ism] = [];
        map[r.ism].push({
          sana: r.sana,
          tur: r.tur,
          summa: parseFloat(r.summa),
          izoh: r.izoh
        });
      });
      nasiyalarData = Object.keys(map).map(name => ({
        ism: name,
        tarix: map[name]
      }));
      renderNasiyaList();
    }

    function renderNasiyaList() {
      const listEl = document.getElementById("nasiyaList");
      listEl.innerHTML = "";
      let total = 0;

      nasiyalarData.forEach(item => {
        let qoldiq = 0;
        item.tarix.forEach(t => {
          if (t.tur === "oldi") qoldiq += t.summa;
          else if (t.tur === "berdi") qoldiq -= t.summa;
        });
        total += qoldiq;

        const wrapper = document.createElement("div");
        wrapper.className = "nasiya";

        const header = document.createElement("div");
        header.className = "nasiya-header";
        header.textContent = `${item.ism} ${formatSum(qoldiq)}`;

        const details = document.createElement("div");
        details.className = "tarix";
        item.tarix
          .filter(t => !(t.tur === "berdi" && t.summa === 0))
          .forEach(t => {
            const p = document.createElement("div");
            p.textContent = `${t.sana} – ${t.tur} – ${formatSum(t.summa)}`;
            details.appendChild(p);
          });

        header.addEventListener("click", () => {
          details.style.display = details.style.display === "block" ? "none" : "block";
        });

        wrapper.appendChild(header);
        wrapper.appendChild(details);
        listEl.appendChild(wrapper);
      });

      document.getElementById("totalSum").textContent = `Nasiyalar: ${formatSum(total)}`;
    }

    const addBtn = document.getElementById("addNasiyaBtn");
    const modal = document.getElementById("nasiyaModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const form = document.getElementById("nasiyaForm");

    addBtn.addEventListener("click", () => modal.style.display = "flex");
    closeModalBtn.addEventListener("click", () => modal.style.display = "none");

    form.addEventListener("submit", async e => {
      e.preventDefault();

      // 1) Modalni oldin yopamiz va tugmani bloklaymiz
      modal.style.display = "none";
      addBtn.disabled = true;

      // 2) Form ma'lumotlari
      const ism   = document.getElementById("formIsm").value.trim();
      const oldi  = parseFloat(document.getElementById("formOldi").value)  || 0;
      const berdi = parseFloat(document.getElementById("formBerdi").value) || 0;
      const foiz  = parseFloat(document.getElementById("formFoiz").value)  || 0;
      const izoh  = document.getElementById("formIzoh").value.trim();
      const sana  = new Date().toLocaleString("uz-UZ", { hour12: false });

      const headers = { 'Content-Type': 'application/json' };

      // 3) Yazuvlarni jo'natish
      if (oldi > 0) {
        const adj = oldi + oldi * foiz / 100;
        await fetch(API_URL, {
          method: "POST",
          headers,
          body: JSON.stringify({ ism, sana, tur: "oldi", summa: adj, izoh })
        });
      }
      if (berdi > 0) {
        await fetch(API_URL, {
          method: "POST",
          headers,
          body: JSON.stringify({ ism, sana, tur: "berdi", summa: berdi, izoh })
        });
      }

      // 4) Ro'yxatni yangilaymiz
      await loadNasiyalar();

      // 5) Tugmani faollik va formni tozalash
      addBtn.disabled = false;
      form.reset();
    });

    window.addEventListener("DOMContentLoaded", loadNasiyalar);
  </script>
</body>
</html>
